###############################################################################################################
# @@TODO's
#
# 3: rationalise dump file name
# 4: check source file referencing
# 5: Check/replace sp-to-bw map (based on RDF using output from sites transformation)
#
###############################################################################################################

{
    type : "Composite",
    "name" : "short-term-pollution-risk-prediction",
    "required" : [
         "site",
         "datetime",
         "prediction",
         "prediction_text_en"
#         "Prediction_text_cy"
         ],
    "bind" : [
        {
            "$source_base"        : "http://environment.data.gov.uk/sources/bwq",
            "$data_base"          : "http://environment.data.gov.uk/data/bathing-water-quality",
            "$body_slug"          : "eaew",
            "$body_org"           : "http://reference.data.gov.uk/id/public-body/environment-agency",
            "$def_bw"             : "http://environment.data.gov.uk/def/bathing-water",
            "$def_sp"             : "http://location.data.gov.uk/def/ef/SamplingPoint",
            "$def_stp"            : "http://environment.data.gov.uk/def/bwq-stp",
            "$id_bw"              : "http://environment.data.gov.uk/id/bathing-water",
            "$so_sp"              : "http://location.data.gov.uk/so/ef/SamplingPoint/bwsp.eaew",
            "$so_env"             : "http://location.data.gov.uk/so/common/Envelope/bwpf.eaew",
            "$so_zoi"             : "http://location.data.gov.uk/so/ef/ZoneOfInfluence/bwzoi.eaew",
            "$bwspid"             : "{site.format('%05d')}",
            "$pubDateTime"        : "{$exectime.asDate('xsd:dateTime').toWholeSeconds().toLocalTime()}",
            "$predictionDateTime" : "{datetime.asDate('YYYY-MM-dd\\'T\\'hh:mm:ss|YYYY-MM-dd\\'T\\'hh:mm:ssZZ|YYYY-MM-dd\\'T\\'hh:mm:ssZ','xsd:dateTime').toLocalTime()}",
            "$expiresDateTime"    : "{$predictionDateTime.plus(23,59,0)}",
            "$ns"                 : "{= asResource($$).replaceAll('#$','') }"
        },
        {
############################################################################################################            
# The following expression is a monster because I couldn't get format('%1tY%1tM%1td-%1tH%1tm%1ts') to work.
############################################################################################################
#            "$pubDateTimeSlug" : 
#                 "{$pubDateTime.year.format('%04d')}{$pubDateTime.month.format('%02d')}{$pubDateTime.day.format('%02d')}-{$pubDateTime.hour.format('%02d')}{$pubDateTime.minute.format('%02d')}{$pubDateTime.fullSecond.format('%02d')}",
            "$pubDateTimeSlug" : "{$pubDateTime.format('YYYYMMdd-hhmmss')}",
            "$stpDataset"      : "{$data_base}/stp-risk-prediction",
            "$bodyStpDataset"  : "{$data_base}/{$body_slug}/stp-risk-prediction"
        },{
            "$incrementalStpDataset" : "{$bodyStpDataset}/dataset-increment/{$pubDateTimeSlug}"
        }
    ],
    "oneOffs" : [
       { "name"              : "stp-dataset" ,
         "@id"               : "<{$stpDataset}>" ,
         "<rdf:type>"        : ["<void:Dataset>", "<qb:DataSet>", "<def-stp:RiskPredictionDataSet>" ],
         "<rdfs:label>"      : "Bathing Water Quality Short Term Pollution Risk Prediction@en" ,
         "<dct:description>" : "Top level dataset recording predictions of short term pollution risk, typically due to rainfall, associated with designated bathing waters in the UK.@en",
         "<dct:license>"     : "<http://reference.data.gov.uk/id/open-government-licence>",
         "<qb:structure>"    : "<def-stp:riskDsd>",
         "<void:subset>"     : "<{$bodyStpDataset}>",
         "<void:uriRegexPattern>" : "http://environment.data.gov.uk/data/bathing-water-quality/stp-risk-prediction/(.*)",
         "<void:vocabulary>"      : [ "<{$ns.apply('dgu:'     )}>",
                                      "<{$ns.apply('def-bwq:' )}>",
                                      "<{$ns.apply('skos:'    )}>",
                                      "<{$ns.apply('def-bw:'  )}>",
                                      "<{$ns.apply('def-sp:'  )}>",
                                      "<{$ns.apply('def-stp:' )}>",
                                      "<{$ns.apply('qb:'      )}>" ]
       },{
         "name"              : "body-stp-dataset",
         "@id"               : "<{$bodyStpDataset}>",
         "<rdf:type>"        : [ "<void:Dataset>", "<qb:DataSet>", "<def-stp:RiskPredictionDataSet>" ],
         "<rdfs:label>"      : "Bathing Water Quality Short Term Pollution Risk Prediction Dataset - ({$body_slug})@en" ,
         "<dct:description>" : "Dataset recording recording predictions of short term pollution risk, typically due to rainfall, associated with designated bathing waters monitored by a monitoring body - ({$body_slug})@en",
         "<dct:license>"     : "<http://reference.data.gov.uk/id/open-government-licence>",
         "<qb:structure>"    : "<def-stp:riskDsd>",
         "<void:uriRegexPattern>" : "http://environment.data.gov.uk/data/bathing-water-quality/stp-risk-prediction/(.*)",
         "<dct:publisher>"   : "<{$body_org}>",
         "<void:vocabulary>" : [ "<{$ns.apply('dgu:')}>",
                                   "<{$ns.apply('def-bwq:')}>",
                                   "<{$ns.apply('skos:'   )}>",
                                   "<{$ns.apply('def-bw:' )}>",
                                   "<{$ns.apply('def-sp:' )}>",
                                   "<{$ns.apply('def-stp:')}>",
                                   "<{$ns.apply('qb:')    }>" ],
         "<dct:modified>"    : "{$pubDateTime}",
         "<void:subset>"     : "<{$incrementalStpDataset}>"
       },{
         "name"              : "incremental-stp-dataset",
         "@id"               : "<{$incrementalStpDataset}>",
         "<rdf:type>"        : [ "<void:Dataset>" ],
         "<rdfs:label>"      : "Bathing Water Quality - short-term pollution risk prediction incremental dataset - ({$body_slug} {$pubDateTime})@en" ,
         "<dct:description>" : "Incremental short-term pollution risk prediction dataset - ({$body_slug}  {$pubDateTime})@en",
         "<dct:license>"     : "<http://reference.data.gov.uk/id/open-government-licence>",
         "<dct:publisher>"   : "<{$body_org}>",
         "<void:vocabulary>" : [ "<{$ns.apply('dgu:')}>",
                                   "<{$ns.apply('def-bwq:')}>",
                                   "<{$ns.apply('skos:'   )}>",
                                   "<{$ns.apply('def-bw:' )}>",
                                   "<{$ns.apply('def-sp:' )}>",
                                   "<{$ns.apply('def-stp:')}>",
                                   "<{$ns.apply('qb:')    }>" ],
         "<dct:modified>"    : "{$pubDateTime}",
# @@TODO 3: rationalise dump file name
         "<void:datadump>"   : "<{$source_base}/{$body_slug}/output/{$filebasename}-{$pubDateTime}.ttl>"
       }
    ],
 ##########################################################################################################
 # Main STP conversion template.
 ##########################################################################################################
    "templates" : [ "stp" ] ,
    "referenced" : [
       { "name" : "stp",
         "@id"  : "<{$stpDataset}/point/{$bwspid}/dateTime/{$pubDateTimeSlug}>",
         "<rdfs:type>"            : "<{$def_stp}/RiskPrediction>",
         "<def-stp:publishedAt>"  : "{$pubDateTime}",
         "<def-stp:predictedAt>"  : "{$predictionDateTime}",
 # There may be a better way to extract date from dateTime, but a simple .asDate('xsd:date') doesn't do it
         "<def-stp:predictedOn>"  : "{$predictionDateTime.year.format('%04d').append('-').append($predictionDateTime.month.format('%02d')).append('-').append($predictionDateTime.day.format('%02d')).asDate('YYYY-MM-dd','xsd:date')}",
         "<def-stp:expiresAt>"    : "{$expiresDateTime}",
         "<def-stp:riskLevel>"    : "<{prediction.value == 0 ? $def_stp.append('/unknown') :
                                       prediction.value == 1 ? $def_stp.append('/normal')  :
                                       prediction.value == 2 ? $def_stp.append('/increased') : null}>",
         "<def-stp:samplingPoint>": "<{$so_sp}/{$bwspid}>",
         "<def-stp:bathingWater>" : "<{$bwspid.map('sp-to-bw')}>",
         "<rdfs:comment>"         : [ "{prediction_text_en.lang('en')}", "{prediction_text_cy.lang('cy')}" ],
 # @@TODO 4: check source file referencing
         "<dct:source>"           : "<{$source_base}/{$body_slug}/input/{$filename}#line={value($row.number).format('%04d')}>",
         "<qb:dataSet>"           : [ "<{$stpDataset}>", "<{$bodyStpDataset}>" ]
       }
   ]
}